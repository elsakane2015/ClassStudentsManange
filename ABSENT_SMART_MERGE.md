# æ—·è¯¾æ™ºèƒ½åˆå¹¶åŠŸèƒ½å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆï¼šæ—·è¯¾è®°å½•æ™ºèƒ½åˆå¹¶

### éœ€æ±‚
å½“å¯¹åŒä¸€å­¦ç”Ÿå¤šæ¬¡æ ‡è®°æ—·è¯¾æ—¶ï¼Œåº”è¯¥åˆå¹¶ä¸ºä¸€æ¡è®°å½•ï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºå¤šä¸ªå¾½ç« ã€‚

**æœŸæœ›æ•ˆæœ**ï¼š
- ç¬¬ä¸€æ¬¡æ ‡è®°ï¼šæ—·è¯¾ï¼ˆç¬¬1,2èŠ‚ï¼‰
- ç¬¬äºŒæ¬¡æ ‡è®°æ—¶ï¼šèŠ‚æ¬¡é€‰æ‹©å™¨ä¸­ç¬¬1ã€2èŠ‚å·²è¢«é€‰ä¸­
- ç”¨æˆ·å†é€‰æ‹©ç¬¬3ã€4èŠ‚
- ç»“æœï¼šåˆå¹¶æ˜¾ç¤º `[æ—·è¯¾(ç¬¬1,2,3,4èŠ‚)]`

---

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### 1. é¢„å¡«å……å·²æœ‰èŠ‚æ¬¡

å½“æ‰“å¼€æ—·è¯¾è¾“å…¥æ¡†æ—¶ï¼Œè‡ªåŠ¨åŠ è½½è¯¥å­¦ç”Ÿå·²æœ‰çš„æ—·è¯¾èŠ‚æ¬¡å¹¶é¢„é€‰ä¸­ã€‚

**å®ç°ä»£ç **ï¼š
```javascript
// å¯¹äºæ—·è¯¾ï¼Œé¢„å¡«å……å·²æœ‰çš„èŠ‚æ¬¡
if (status === 'absent' && selectedStudentIds.size > 0) {
    const firstStudentId = Array.from(selectedStudentIds)[0];
    const student = students.find(s => s.id === firstStudentId);
    
    if (student && student.attendance_records) {
        // æŸ¥æ‰¾æ‰€æœ‰æ—·è¯¾è®°å½•
        const absentRecords = student.attendance_records.filter(r => r.status === 'absent');
        
        // æ”¶é›†æ‰€æœ‰å·²æ—·è¯¾çš„èŠ‚æ¬¡
        const existingPeriods = [];
        absentRecords.forEach(record => {
            if (record.details && record.details.periods) {
                existingPeriods.push(...record.details.periods);
            }
        });
        
        // å»é‡å¹¶é¢„å¡«å……
        const uniquePeriods = [...new Set(existingPeriods)];
        setInputData(uniquePeriods.length > 0 ? { periods: uniquePeriods } : {});
    }
}
```

### 2. åˆ é™¤æ—§è®°å½•å¹¶åˆ›å»ºåˆå¹¶è®°å½•

æäº¤æ—¶ï¼Œå…ˆåˆ é™¤æ‰€æœ‰æ—§çš„æ—·è¯¾è®°å½•ï¼Œç„¶ååˆ›å»ºæ–°çš„åˆå¹¶è®°å½•ã€‚

**å®ç°ä»£ç **ï¼š
```javascript
// æ—·è¯¾ï¼šå…ˆåˆ é™¤æ—§çš„æ—·è¯¾è®°å½•ï¼Œç„¶ååˆ›å»ºæ–°çš„åˆå¹¶è®°å½•
for (const studentId of selectedStudentIds) {
    const student = students.find(s => s.id === studentId);
    if (student && student.attendance_records) {
        const absentRecords = student.attendance_records.filter(r => r.status === 'absent');
        
        // åˆ é™¤æ‰€æœ‰æ—·è¯¾è®°å½•
        for (const record of absentRecords) {
            await axios.delete('/attendance/record', {
                data: {
                    student_id: studentId,
                    date: formattedDate,
                    period_id: record.period_id
                }
            });
        }
    }
}

// åˆ›å»ºæ–°çš„åˆå¹¶è®°å½•
await axios.post('/attendance/bulk', {
    date: formattedDate,
    period_id: periodIds[0],
    records: records  // details.periods = [1,2,3,4]
});
```

---

## ğŸ“Š ä½¿ç”¨æµç¨‹

### åœºæ™¯ï¼šå¤šæ¬¡æ ‡è®°æ—·è¯¾

#### ç¬¬ä¸€æ¬¡æ ‡è®°
1. é€‰æ‹©å­¦ç”Ÿï¼ˆå¦‚testï¼‰
2. ç‚¹å‡»"æ—·è¯¾"æŒ‰é’®
3. é€‰æ‹©ç¬¬1ã€2èŠ‚
4. ç‚¹å‡»"ç¡®å®š"

**ç»“æœ**ï¼š
```
æ•°æ®åº“ï¼š1æ¡è®°å½• (period_id=1, details={periods:[1,2]})
æ˜¾ç¤ºï¼š[æ—·è¯¾(ç¬¬1,2èŠ‚)]
```

#### ç¬¬äºŒæ¬¡æ ‡è®°ï¼ˆåˆå¹¶ï¼‰
1. å†æ¬¡é€‰æ‹©åŒä¸€å­¦ç”Ÿï¼ˆtestï¼‰
2. ç‚¹å‡»"æ—·è¯¾"æŒ‰é’®
3. **è‡ªåŠ¨é¢„é€‰ä¸­**ï¼šç¬¬1ã€2èŠ‚å·²è¢«é€‰ä¸­ âœ…
4. ç”¨æˆ·å†é€‰æ‹©ç¬¬3ã€4èŠ‚
5. ç‚¹å‡»"ç¡®å®š"

**åå°æ“ä½œ**ï¼š
```
1. åˆ é™¤æ—§è®°å½•ï¼šDELETE (period_id=1)
2. åˆ›å»ºæ–°è®°å½•ï¼šCREATE (period_id=1, details={periods:[1,2,3,4]})
```

**ç»“æœ**ï¼š
```
æ•°æ®åº“ï¼š1æ¡è®°å½• (period_id=1, details={periods:[1,2,3,4]})
æ˜¾ç¤ºï¼š[æ—·è¯¾(ç¬¬1,2,3,4èŠ‚)]  âœ…
```

---

## ğŸ¯ æ•°æ®æµ

### æ‰“å¼€æ—·è¯¾è¾“å…¥æ¡†
```
ç”¨æˆ·ç‚¹å‡»"æ—·è¯¾"
  â†“
æ£€æŸ¥é€‰ä¸­å­¦ç”Ÿçš„æ—·è¯¾è®°å½•
  â†“
æå–æ‰€æœ‰æ—·è¯¾èŠ‚æ¬¡ï¼š[1, 2]
  â†“
é¢„å¡«å……åˆ°è¾“å…¥æ¡†ï¼šç¬¬1ã€2èŠ‚è¢«é€‰ä¸­
  â†“
ç”¨æˆ·çœ‹åˆ°å·²é€‰ä¸­çš„èŠ‚æ¬¡
```

### æäº¤æ—·è¯¾è®°å½•
```
ç”¨æˆ·é€‰æ‹©ï¼šç¬¬1ã€2ã€3ã€4èŠ‚
  â†“
åˆ é™¤æ—§è®°å½•ï¼š
  - DELETE (student_id=1, date='2025-12-18', period_id=1)
  â†“
åˆ›å»ºæ–°è®°å½•ï¼š
  - CREATE (period_id=1, details={periods:[1,2,3,4]})
  â†“
åˆ·æ–°é¡µé¢
  â†“
æ˜¾ç¤ºï¼š[æ—·è¯¾(ç¬¬1,2,3,4èŠ‚)]
```

---

## âœ¨ ä¼˜åŠ¿

### 1. ç”¨æˆ·ä½“éªŒ
- âœ… è‡ªåŠ¨é¢„é€‰å·²æ—·è¯¾çš„èŠ‚æ¬¡ï¼Œç”¨æˆ·æ— éœ€è®°å¿†
- âœ… å¯ä»¥ç›´æ¥çœ‹åˆ°ä¹‹å‰æ ‡è®°çš„èŠ‚æ¬¡
- âœ… æ·»åŠ æ–°èŠ‚æ¬¡æ—¶ä¸ä¼šä¸¢å¤±æ—§èŠ‚æ¬¡

### 2. æ•°æ®ä¸€è‡´æ€§
- âœ… æ¯ä¸ªå­¦ç”Ÿæ¯å¤©åªæœ‰ä¸€æ¡æ—·è¯¾è®°å½•
- âœ… é¿å…é‡å¤æ˜¾ç¤º
- âœ… æ•°æ®æ›´æ¸…æ™°

### 3. æ“ä½œä¾¿æ·
- âœ… æ”¯æŒå¢é‡æ·»åŠ èŠ‚æ¬¡
- âœ… æ”¯æŒä¿®æ”¹å·²é€‰èŠ‚æ¬¡ï¼ˆå–æ¶ˆå‹¾é€‰ï¼‰
- âœ… ä¸€æ¬¡æ“ä½œå®Œæˆåˆå¹¶

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡æ ‡è®°æ—·è¯¾
1. é€‰æ‹©å­¦ç”Ÿ
2. ç‚¹å‡»"æ—·è¯¾"
3. é€‰æ‹©ç¬¬1ã€2èŠ‚
4. ç‚¹å‡»"ç¡®å®š"
5. âœ… æ˜¾ç¤ºï¼š`[æ—·è¯¾(ç¬¬1,2èŠ‚)]`

### åœºæ™¯2ï¼šè¿½åŠ æ—·è¯¾èŠ‚æ¬¡
1. é€‰æ‹©åŒä¸€å­¦ç”Ÿ
2. ç‚¹å‡»"æ—·è¯¾"
3. âœ… ç¬¬1ã€2èŠ‚å·²è¢«é€‰ä¸­
4. å†é€‰æ‹©ç¬¬3ã€4èŠ‚
5. ç‚¹å‡»"ç¡®å®š"
6. âœ… æ˜¾ç¤ºï¼š`[æ—·è¯¾(ç¬¬1,2,3,4èŠ‚)]`ï¼ˆåªæœ‰ä¸€ä¸ªå¾½ç« ï¼‰

### åœºæ™¯3ï¼šä¿®æ”¹æ—·è¯¾èŠ‚æ¬¡
1. é€‰æ‹©åŒä¸€å­¦ç”Ÿ
2. ç‚¹å‡»"æ—·è¯¾"
3. âœ… ç¬¬1ã€2ã€3ã€4èŠ‚å·²è¢«é€‰ä¸­
4. å–æ¶ˆå‹¾é€‰ç¬¬2èŠ‚
5. ç‚¹å‡»"ç¡®å®š"
6. âœ… æ˜¾ç¤ºï¼š`[æ—·è¯¾(ç¬¬1,3,4èŠ‚)]`

### åœºæ™¯4ï¼šæ’¤é”€æ—·è¯¾
1. ç‚¹å‡»æ—·è¯¾å¾½ç« 
2. ç¡®è®¤æ’¤é”€
3. âœ… æ‰€æœ‰æ—·è¯¾èŠ‚æ¬¡éƒ½è¢«åˆ é™¤

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `resources/js/components/AttendanceUpdateModal.jsx`
   - ç¬¬109-129è¡Œï¼šæ·»åŠ æ—·è¯¾èŠ‚æ¬¡é¢„å¡«å……é€»è¾‘
   - ç¬¬194-220è¡Œï¼šæ·»åŠ æ—§è®°å½•åˆ é™¤é€»è¾‘

---

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### é¢„å¡«å……é€»è¾‘
```javascript
// æ”¶é›†æ‰€æœ‰æ—·è¯¾è®°å½•çš„èŠ‚æ¬¡
const existingPeriods = [];
absentRecords.forEach(record => {
    if (record.details && record.details.periods) {
        existingPeriods.push(...record.details.periods);
    }
});

// å»é‡
const uniquePeriods = [...new Set(existingPeriods)];

// è®¾ç½®åˆ°è¾“å…¥æ¡†
setInputData({ periods: uniquePeriods });
```

### åˆ é™¤é€»è¾‘
```javascript
// åˆ é™¤æ‰€æœ‰æ—·è¯¾è®°å½•
for (const record of absentRecords) {
    await axios.delete('/attendance/record', {
        data: {
            student_id: studentId,
            date: formattedDate,
            period_id: record.period_id
        }
    });
}
```

### åˆå¹¶é€»è¾‘
- åˆ é™¤æ‰€æœ‰æ—§è®°å½•
- åˆ›å»ºä¸€æ¡æ–°è®°å½•
- æ–°è®°å½•åŒ…å«æ‰€æœ‰èŠ‚æ¬¡ï¼ˆæ—§çš„+æ–°çš„ï¼‰

---

## ğŸ¨ UIæ•ˆæœ

### ä¿®æ”¹å‰
```
ç¬¬ä¸€æ¬¡ï¼š[æ—·è¯¾(ç¬¬1,2èŠ‚)]
ç¬¬äºŒæ¬¡ï¼š[æ—·è¯¾(ç¬¬1,2èŠ‚)] [æ—·è¯¾(ç¬¬3,4èŠ‚)]  â† é‡å¤æ˜¾ç¤º
```

### ä¿®æ”¹å
```
ç¬¬ä¸€æ¬¡ï¼š[æ—·è¯¾(ç¬¬1,2èŠ‚)]
ç¬¬äºŒæ¬¡ï¼š[æ—·è¯¾(ç¬¬1,2,3,4èŠ‚)]  â† æ™ºèƒ½åˆå¹¶ âœ…
```

---

*å®Œæˆæ—¶é—´: 2025-12-18 13:18*
*åŠŸèƒ½: æ—·è¯¾æ™ºèƒ½åˆå¹¶*
*çŠ¶æ€: âœ… å·²å®Œæˆ*
