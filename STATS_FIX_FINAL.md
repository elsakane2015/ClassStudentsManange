# æ¦‚è§ˆç»Ÿè®¡ä¿®å¤æŠ¥å‘Šï¼ˆæœ€ç»ˆç‰ˆï¼‰

## âŒ é—®é¢˜ï¼šç—…å‡/äº‹å‡ç­‰æ²¡æœ‰ç»Ÿè®¡åˆ°

**ç°è±¡**ï¼š
æ¦‚è§ˆé¡µé¢ä¸­æ˜¾ç¤ºçš„æ‰€æœ‰è¯·å‡ç±»å‹ç»Ÿè®¡éƒ½æ˜¯0ã€‚

**æ ¹æœ¬åŸå› **ï¼š
åç«¯æŸ¥è¯¢ä½¿ç”¨çš„çŠ¶æ€å€¼ä¸å‰ç«¯å®é™…ä¿å­˜çš„çŠ¶æ€å€¼ä¸åŒ¹é…ã€‚

### çŠ¶æ€å€¼ä¸åŒ¹é…

**å‰ç«¯ä¿å­˜çš„çŠ¶æ€**ï¼ˆ`AttendanceUpdateModal.jsx`ï¼‰ï¼š
```javascript
// å¯¹äºç—…å‡ã€äº‹å‡ç­‰è¯·å‡ç±»å‹
let status = 'leave';  // â† ä½¿ç”¨ 'leave'
if (['late', 'absent', 'early_leave'].includes(lt.slug)) {
    status = lt.slug;
}
```

**åç«¯æŸ¥è¯¢çš„çŠ¶æ€**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
```php
$leaveStatsRaw = $attendanceQuery->clone()
     ->where('status', 'excused')  // â† æŸ¥è¯¢ 'excused'
     ->join('leave_types', ...)
```

**ç»“æœ**ï¼šæŸ¥è¯¢æ¡ä»¶ `status = 'excused'` æ‰¾ä¸åˆ°ä»»ä½•è®°å½•ï¼Œå› ä¸ºå®é™…ä¿å­˜çš„æ˜¯ `status = 'leave'`ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤1ï¼šæ•°æ®æ ¼å¼è½¬æ¢ï¼ˆå·²å®Œæˆï¼‰
å°† `leaveStats` ä»æ•°ç»„è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼ã€‚

### ä¿®å¤2ï¼šçŠ¶æ€å€¼åŒ¹é…ï¼ˆå…³é”®ä¿®å¤ï¼‰
å°†æŸ¥è¯¢æ¡ä»¶ä» `'excused'` æ”¹ä¸º `'leave'`ï¼š

```php
$leaveStatsRaw = $attendanceQuery->clone()
     ->where('status', 'leave')  // â† ä¿®æ”¹ä¸º 'leave'
     ->join('leave_types', 'attendance_records.leave_type_id', '=', 'leave_types.id')
     ->selectRaw('leave_types.name as type_name, leave_types.id as type_id, count(*) as count')
     ->groupBy('leave_types.id', 'leave_types.name')
     ->get();
```

---

## ğŸ“Š çŠ¶æ€å€¼å¯¹ç…§è¡¨

| è¯·å‡ç±»å‹ | å‰ç«¯slug | ä¿å­˜çš„status | è¯´æ˜ |
|---------|---------|-------------|------|
| ç—…å‡ | sick_leave | **leave** | é€šç”¨è¯·å‡çŠ¶æ€ |
| äº‹å‡ | personal_leave | **leave** | é€šç”¨è¯·å‡çŠ¶æ€ |
| ç”Ÿç†å‡ | health_leave | **leave** | é€šç”¨è¯·å‡çŠ¶æ€ |
| è¿Ÿåˆ° | late | **late** | ç‰¹æ®ŠçŠ¶æ€ |
| æ—©é€€ | early_leave | **early_leave** | ç‰¹æ®ŠçŠ¶æ€ |
| æ—·è¯¾ | absent | **absent** | ç‰¹æ®ŠçŠ¶æ€ |

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. åˆ·æ–°æ¦‚è§ˆé¡µé¢
2. æŸ¥çœ‹ç»Ÿè®¡å¡ç‰‡
3. âœ… åº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„æ•°å­—ï¼š
   - ä»Šæ—¥ç—…å‡ï¼šå®é™…æ•°é‡ï¼ˆå¦‚2ï¼‰
   - ä»Šæ—¥äº‹å‡ï¼šå®é™…æ•°é‡ï¼ˆå¦‚1ï¼‰
   - ä»Šæ—¥ç”Ÿç†å‡ï¼šå®é™…æ•°é‡
   - ç­‰ç­‰

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `app/Http/Controllers/Api/AttendanceController.php`
   - ç¬¬86è¡Œï¼šå°† `where('status', 'excused')` æ”¹ä¸º `where('status', 'leave')`
   - ç¬¬92-96è¡Œï¼šæ·»åŠ æ•°ç»„åˆ°å¯¹è±¡çš„è½¬æ¢é€»è¾‘

---

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆæœ‰ä¸¤ç§çŠ¶æ€å€¼ï¼Ÿ

1. **é€šç”¨è¯·å‡çŠ¶æ€** (`leave`)ï¼š
   - ç—…å‡ã€äº‹å‡ã€ç”Ÿç†å‡ç­‰éƒ½ä½¿ç”¨è¿™ä¸ªçŠ¶æ€
   - é€šè¿‡ `leave_type_id` å­—æ®µåŒºåˆ†å…·ä½“ç±»å‹

2. **ç‰¹æ®ŠçŠ¶æ€** (`late`, `absent`, `early_leave`)ï¼š
   - è¿™äº›çŠ¶æ€æœ¬èº«å°±æ˜¯ç±»å‹ï¼Œä¸éœ€è¦é¢å¤–çš„ `leave_type_id`
   - ç›´æ¥ä½¿ç”¨çŠ¶æ€å€¼å³å¯åŒºåˆ†

### æŸ¥è¯¢é€»è¾‘

```php
// åªæŸ¥è¯¢ status='leave' çš„è®°å½•
->where('status', 'leave')
// é€šè¿‡ leave_type_id å…³è”åˆ° leave_types è¡¨
->join('leave_types', 'attendance_records.leave_type_id', '=', 'leave_types.id')
// æŒ‰è¯·å‡ç±»å‹åˆ†ç»„ç»Ÿè®¡
->groupBy('leave_types.id', 'leave_types.name')
```

---

*ä¿®å¤æ—¶é—´: 2025-12-18 12:41*
*é—®é¢˜: çŠ¶æ€å€¼ä¸åŒ¹é…å¯¼è‡´ç»Ÿè®¡ä¸º0*
*çŠ¶æ€: âœ… å·²ä¿®å¤*
