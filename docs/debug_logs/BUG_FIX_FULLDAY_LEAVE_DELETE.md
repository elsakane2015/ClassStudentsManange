# Bug修复 - 全天病假/事假删除其他记录

## 🐛 问题描述

**用户报告**：
- Student Manager有"病假（全天）"和"旷课（第2节）"两条记录
- 问题：如果已经请了全天病假，不应该再有其他记录

**原因**：
- 之前为了保留生理假的记录，禁用了删除逻辑
- 但全天病假/事假应该删除所有其他时段记录

---

## 🔍 逻辑分析

### 业务规则

1. **全天病假/事假**：
   - 学生全天都在请假
   - 不应该有其他考勤记录（出勤、旷课、迟到等）
   - **需要删除**所有时段记录

2. **全天生理假**：
   - 这种情况不存在（生理假只有早操/晚操）
   - 不影响

3. **半天病假/事假**：
   - 只影响半天
   - 另外半天可以有其他记录
   - **不删除**其他时段记录

---

## ✅ 修复方案

### 选择性删除逻辑

**文件**：`app/Services/AttendanceService.php` (第63-77行)

**核心逻辑**：
```php
// 特殊规则：全天病假/事假，删除所有时段记录
// 只对病假和事假的全天记录删除其他时段记录
if (isset($options['leave_type_id'])) {
    $leaveType = \App\Models\LeaveType::find($options['leave_type_id']);
    
    // 只对病假(sick_leave)和事假(personal_leave)的全天记录删除时段记录
    if ($leaveType && in_array($leaveType->slug, ['sick_leave', 'personal_leave'])) {
        // 这是全天病假/事假，删除所有时段记录
        AttendanceRecord::where('student_id', $studentId)
            ->where('date', $date)
            ->whereNotNull('period_id')
            ->delete();
        
        \Log::info("Full-day {$leaveType->name} for student {$studentId} on {$date}, deleted all period records");
    }
}
```

---

## 📊 行为对比

### 场景1：全天病假

**操作**：
1. 已有"旷课（第2节）"记录
2. 添加"病假（全天）"

**修复前**：
- ✅ 病假（全天）
- ❌ 旷课（第2节）← 不应该存在

**修复后**：
- ✅ 病假（全天）
- ✅ 删除了"旷课（第2节）"

### 场景2：全天事假

**操作**：
1. 已有"出勤"记录
2. 已有"迟到（15:46）"记录
3. 添加"事假（全天）"

**修复前**：
- ✅ 事假（全天）
- ❌ 出勤 ← 不应该存在
- ❌ 迟到（15:46）← 不应该存在

**修复后**：
- ✅ 事假（全天）
- ✅ 删除了"出勤"和"迟到"

### 场景3：半天病假

**操作**：
1. 已有"出勤"记录
2. 添加"病假（上午）"

**结果**：
- ✅ 出勤
- ✅ 病假（上午）
- ✅ 不删除其他记录（因为不是全天）

### 场景4：生理假（早操+晚操）

**操作**：
1. 添加"生理假（早操）"
2. 添加"生理假（晚操）"

**结果**：
- ✅ 生理假（早操）
- ✅ 生理假（晚操）
- ✅ 不删除，不合并（因为不是病假/事假）

---

## 🔧 技术细节

### 删除条件

删除需要同时满足以下条件：

1. **是全天记录**：
   ```php
   $periodId === null
   ```

2. **是病假或事假**：
   ```php
   in_array($leaveType->slug, ['sick_leave', 'personal_leave'])
   ```

3. **有leave_type_id**：
   ```php
   isset($options['leave_type_id'])
   ```

### 删除范围

```php
AttendanceRecord::where('student_id', $studentId)
    ->where('date', $date)
    ->whereNotNull('period_id')  // 只删除时段记录，不删除全天记录
    ->delete();
```

**删除**：
- ✅ 所有时段记录（period_id不为null）
- ✅ 包括：出勤、旷课、迟到、早退、其他请假等

**保留**：
- ✅ 全天记录（period_id为null）

---

## 🎯 完整的考勤规则

### 病假/事假规则

| 类型 | 时段 | 合并规则 | 删除规则 |
|------|------|---------|---------|
| 病假 | 上午 | 不合并 | 不删除 |
| 病假 | 下午 | 不合并 | 不删除 |
| 病假 | 上午+下午 | **合并为全天** | **删除所有时段记录** |
| 病假 | 全天 | - | **删除所有时段记录** |
| 事假 | 上午 | 不合并 | 不删除 |
| 事假 | 下午 | 不合并 | 不删除 |
| 事假 | 上午+下午 | **合并为全天** | **删除所有时段记录** |
| 事假 | 全天 | - | **删除所有时段记录** |

### 生理假规则

| 类型 | 时段 | 合并规则 | 删除规则 |
|------|------|---------|---------|
| 生理假 | 早操 | 不合并 | 不删除 |
| 生理假 | 晚操 | 不合并 | 不删除 |
| 生理假 | 早操+晚操 | **不合并** | **不删除** |

### 其他类型规则

| 类型 | 规则 |
|------|------|
| 旷课 | 不合并，不删除 |
| 迟到 | 不合并，不删除 |
| 早退 | 不合并，不删除 |
| 出勤 | 不合并，不删除 |

---

## 🧪 测试验证

### 测试1：全天病假删除旷课

**步骤**：
1. 给Student Manager标记"旷课（第2节）"
2. 给Student Manager请"病假（全天）"

**预期**：
- ✅ 只显示"病假（全天）"
- ✅ "旷课（第2节）"被删除

### 测试2：全天事假删除出勤和迟到

**步骤**：
1. Student 1有"出勤"记录
2. Student 1有"迟到（15:46）"记录
3. 给Student 1请"事假（全天）"

**预期**：
- ✅ 只显示"事假（全天）"
- ✅ "出勤"和"迟到"被删除

### 测试3：半天病假不删除其他记录

**步骤**：
1. Student 2有"出勤"记录
2. 给Student 2请"病假（上午）"

**预期**：
- ✅ 显示"出勤"和"病假（上午）"
- ✅ "出勤"不被删除

### 测试4：生理假不删除不合并

**步骤**：
1. 给Student Manager请"生理假（早操）"
2. 给Student Manager请"生理假（晚操）"

**预期**：
- ✅ 显示"生理假（早操）"和"生理假（晚操）"
- ✅ 不合并，不删除

---

## 📝 修改总结

### 修改的文件

1. ✅ `app/Services/AttendanceService.php` - 添加选择性删除逻辑

### 代码变更

| 类型 | 行数 |
|------|------|
| 删除注释 | 2行 |
| 新增检查 | 5行 |
| 修改逻辑 | 2行 |
| **总计** | **9行** |

### 关键修改

**修改前**：
```php
// 用户要求：不要删除时段记录，保留所有记录
/* ... 删除逻辑被注释 ... */
```

**修改后**：
```php
// 只对病假和事假的全天记录删除其他时段记录
if (isset($options['leave_type_id'])) {
    $leaveType = \App\Models\LeaveType::find($options['leave_type_id']);
    
    if ($leaveType && in_array($leaveType->slug, ['sick_leave', 'personal_leave'])) {
        // 删除所有时段记录
        AttendanceRecord::where('student_id', $studentId)
            ->where('date', $date)
            ->whereNotNull('period_id')
            ->delete();
    }
}
```

---

## 🔍 与合并逻辑的关系

### 两个逻辑的配合

1. **合并逻辑**（第98-164行）：
   - 检测到上午+下午 → 合并为全天
   - 只对病假/事假生效

2. **删除逻辑**（第63-77行）：
   - 创建全天记录 → 删除所有时段记录
   - 只对病假/事假生效

### 完整流程

```
场景：病假（上午） + 病假（下午）

1. 添加病假（上午）
   → 创建记录：病假（上午，period_id=1）

2. 添加病假（下午）
   → 触发合并逻辑
   → 删除：病假（上午）和病假（下午）
   → 创建：病假（全天，period_id=null）
   → 触发删除逻辑
   → 删除：所有其他时段记录（旷课、迟到等）

结果：只有病假（全天）
```

---

## ✅ 验证清单

- [x] 添加请假类型检查
- [x] 只对病假和事假删除
- [x] 只对全天记录删除
- [x] 删除所有时段记录
- [ ] 测试全天病假删除旷课
- [ ] 测试全天事假删除出勤和迟到
- [ ] 测试半天病假不删除
- [ ] 验证日志输出正确

---

*完成时间: 2025-12-19 13:53*
*Bug: 全天病假/事假不删除其他记录*
*修复: 添加选择性删除逻辑*
*状态: ✅ 已修复*
*规则: 全天病假/事假删除所有时段记录*
