# 考勤状态完整规则

## 📋 核心规则

### 规则1：时段事件 → 保留出勤
**场景**：学生到校，但某节课有特殊情况

**操作**：
- 时段选择"第2节"
- 点击"生理假"

**结果**：
```
出勤 | 第2节:生理假
```

**数据库**：
| period_id | status | 说明 |
|-----------|--------|------|
| NULL | present | 自动创建：到校了 |
| 2 | excused | 第2节生理假 |

**含义**：
- ✅ 学生来了（基础状态保留）
- ✅ 第2节请假
- ✅ 其他时段正常上课

---

### 规则2：全天请假 → 替换出勤
**场景**：学生全天病假/事假

**操作**：
- 时段选择"全天"
- 点击"病假"或"事假"

**结果**：
```
病假（全天）
```

**数据库**：
| period_id | status | leave_type | 说明 |
|-----------|--------|------------|------|
| NULL | excused | 病假 | 全天请假 |

**含义**：
- ✅ 学生没来（基础状态替换为病假）
- ✅ 删除所有时段记录
- ✅ 全天都是病假

---

### 规则3：全天出勤 → 保留时段
**场景**：已有时段记录，再标记全天出勤

**操作**：
1. 先标记"第2节生理假"
2. 再选择"全天"，点击"出勤"

**结果**：
```
出勤 | 第2节:生理假
```

**数据库**：
| period_id | status | 说明 |
|-----------|--------|------|
| NULL | present | 全天出勤 |
| 2 | excused | 第2节生理假（保留） |

**含义**：
- ✅ 学生来了
- ✅ 第2节请假记录保留
- ✅ 不删除时段记录

---

### 规则4：全天缺勤 → 删除时段
**场景**：学生全天旷课

**操作**：
- 时段选择"全天"
- 点击"旷课"或"缺勤"

**结果**：
```
缺勤（全天）
```

**数据库**：
| period_id | status | 说明 |
|-----------|--------|------|
| NULL | absent | 全天缺勤 |

**含义**：
- ✅ 学生没来
- ✅ 删除所有时段记录
- ✅ 全天都是缺勤

## 🎯 判断逻辑

### 何时保留基础状态？
```
时段记录（period_id != NULL）
→ 保留"出勤"基础状态
→ 添加时段事件
```

### 何时替换基础状态？
```
全天请假（period_id == NULL && leave_type_id != NULL）
→ 替换为"病假/事假"
→ 删除所有时段记录
```

### 何时删除时段记录？
```
全天请假 OR 全天缺勤
→ 删除所有时段记录
→ 只保留全天记录
```

## 💻 代码实现

### AttendanceService::record()

```php
public function record($studentId, $date, $periodId, $status, $options = [])
{
    // 1. 时段记录：自动创建基础状态
    if ($periodId !== null) {
        if (!$hasBaseStatus) {
            // 自动创建"出勤"
            AttendanceRecord::create([
                'period_id' => null,
                'status' => 'present'
            ]);
        }
    }
    
    // 2. 全天记录：特殊处理
    if ($periodId === null) {
        // 全天请假：删除所有时段记录
        if (in_array($status, ['excused', 'leave']) 
            || isset($options['leave_type_id'])) {
            AttendanceRecord::where('student_id', $studentId)
                ->where('date', $date)
                ->whereNotNull('period_id')
                ->delete();
        }
    }
    
    // 3. 创建或更新记录
    return AttendanceRecord::updateOrCreate([...]);
}
```

## 📊 使用示例

### 示例1：到校 + 第2节生理假

**步骤**：
1. 时段选择"第2节"
2. 点击"生理假"

**数据**：
```
period_id | status  | leave_type
----------|---------|------------
NULL      | present | -           (自动创建)
2         | excused | 生理假      (手动标记)
```

**显示**：
```
出勤 | 第2节:生理假
```

---

### 示例2：全天病假

**步骤**：
1. 时段选择"全天"
2. 点击"病假"

**数据**：
```
period_id | status  | leave_type
----------|---------|------------
NULL      | excused | 病假
```

**显示**：
```
病假（全天）
```

---

### 示例3：先时段，后全天请假

**步骤**：
1. 时段选择"第2节"，点击"生理假"
2. 时段选择"全天"，点击"病假"

**数据变化**：
```
之前：
period_id | status  | leave_type
----------|---------|------------
NULL      | present | -
2         | excused | 生理假

之后：
period_id | status  | leave_type
----------|---------|------------
NULL      | excused | 病假        (时段记录被删除)
```

**显示**：
```
病假（全天）
```

---

### 示例4：先时段，后全天出勤

**步骤**：
1. 时段选择"第2节"，点击"生理假"
2. 时段选择"全天"，点击"出勤"

**数据变化**：
```
之前：
period_id | status  | leave_type
----------|---------|------------
NULL      | present | -
2         | excused | 生理假

之后：
period_id | status  | leave_type
----------|---------|------------
NULL      | present | -           (更新)
2         | excused | 生理假      (保留)
```

**显示**：
```
出勤 | 第2节:生理假
```

## 🎨 UI交互

### 按钮分类

#### 时段事件（保留出勤）
- 迟到
- 早退
- 旷课（时段）

#### 全天请假（替换出勤）
- 病假
- 事假
- 生理假
- 其他请假类型

#### 基础状态
- 出勤（全天）
- 缺勤（全天）

### 操作提示

**标记全天请假时**：
```
⚠️ 标记全天病假将删除所有时段记录，确定继续吗？
[取消] [确定]
```

**标记时段事件时**：
```
ℹ️ 将自动标记为"到校"，并记录第2节生理假
```

## ✅ 完整规则总结

| 操作 | period_id | status | leave_type | 结果 | 时段记录 |
|------|-----------|--------|------------|------|----------|
| 时段迟到 | 2 | late | - | 出勤 + 第2节迟到 | 保留 |
| 时段请假 | 2 | excused | 生理假 | 出勤 + 第2节生理假 | 保留 |
| 全天出勤 | NULL | present | - | 出勤 | 保留 |
| 全天病假 | NULL | excused | 病假 | 病假（全天） | **删除** |
| 全天事假 | NULL | excused | 事假 | 事假（全天） | **删除** |
| 全天缺勤 | NULL | absent | - | 缺勤（全天） | **删除** |

## 🧪 测试用例

### 测试1：时段生理假
1. 选择"第2节"，点击"生理假"
2. ✅ 显示"出勤 | 第2节:生理假"

### 测试2：全天病假
1. 选择"全天"，点击"病假"
2. ✅ 显示"病假（全天）"
3. ✅ 之前的时段记录被删除

### 测试3：时段后改全天
1. 选择"第2节"，点击"生理假"
2. 选择"全天"，点击"病假"
3. ✅ 显示"病假（全天）"
4. ✅ 第2节记录被删除

### 测试4：全天后改时段
1. 选择"全天"，点击"病假"
2. 选择"第2节"，点击"迟到"
3. ✅ 显示"出勤 | 第2节:迟到"
4. ✅ 病假被替换为出勤

## 📝 状态优先级

### 显示优先级
1. 全天请假 > 时段事件
2. 全天缺勤 > 时段事件
3. 全天出勤 + 时段事件 = 并存

### 数据优先级
1. 全天请假 → 删除时段
2. 全天缺勤 → 删除时段
3. 全天出勤 → 保留时段

---

*规则版本: v2.0*
*更新时间: 2025-12-17 15:18*
*核心: 全天请假替换，时段事件累加*
