# æ—·è¯¾ç»Ÿè®¡ä¼˜åŒ–æŠ¥å‘Š

## âœ… éœ€æ±‚

åœ¨æ¦‚è§ˆä¸­ï¼Œæ—·è¯¾ç»Ÿè®¡åº”è¯¥æ˜¾ç¤ºï¼š**å¤šå°‘äºº/å¤šå°‘èŠ‚**

ä¾‹å¦‚ï¼š
- 2ä¸ªäººæ—·è¯¾ï¼Œå…±6èŠ‚ â†’ æ˜¾ç¤º"**2äºº/6èŠ‚**"
- 1ä¸ªäººæ—·è¯¾ï¼Œå…±3èŠ‚ â†’ æ˜¾ç¤º"**1äºº/3èŠ‚**"

---

## ğŸ“Š é—®é¢˜åˆ†æ

### å½“å‰ç»Ÿè®¡æ–¹å¼

**æ—§é€»è¾‘**ï¼šåªç»Ÿè®¡æ—·è¯¾äººæ•°
```php
$leaveStats['æ—·è¯¾'] = $attendanceStats['absent'];  // å¦‚ï¼š2
```

**æ˜¾ç¤º**ï¼šæ—·è¯¾ 2

### é—®é¢˜

æ—·è¯¾è®°å½•ä½¿ç”¨"Smart Merge"é€»è¾‘ï¼š
- ä¸€ä¸ªäººçš„å¤šä¸ªæ—·è¯¾èŠ‚æ¬¡åˆå¹¶ä¸ºä¸€æ¡è®°å½•
- èŠ‚æ¬¡ä¿¡æ¯å­˜å‚¨åœ¨ `details.periods` æˆ– `details.period_numbers` ä¸­
- å½“å‰ç»Ÿè®¡åªè®¡ç®—è®°å½•æ•°ï¼ˆäººæ•°ï¼‰ï¼Œä¸è®¡ç®—èŠ‚æ¬¡æ•°

**ç¤ºä¾‹**ï¼š
```
Student 1: æ—·è¯¾ç¬¬1,2,3èŠ‚ â†’ 1æ¡è®°å½•ï¼Œ3ä¸ªèŠ‚æ¬¡
Student 2: æ—·è¯¾ç¬¬4,5,6èŠ‚ â†’ 1æ¡è®°å½•ï¼Œ3ä¸ªèŠ‚æ¬¡

å½“å‰æ˜¾ç¤ºï¼šæ—·è¯¾ 2ï¼ˆåªæ˜¾ç¤ºäººæ•°ï¼‰
æœŸæœ›æ˜¾ç¤ºï¼šæ—·è¯¾ 2äºº/6èŠ‚ï¼ˆåŒæ—¶æ˜¾ç¤ºäººæ•°å’ŒèŠ‚æ¬¡æ•°ï¼‰
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

1. ç»Ÿè®¡æ—·è¯¾äººæ•°ï¼ˆè®°å½•æ•°ï¼‰
2. è§£ææ¯æ¡è®°å½•çš„ `details` å­—æ®µ
3. ç»Ÿè®¡æ€»èŠ‚æ¬¡æ•°
4. æ˜¾ç¤ºä¸º"Xäºº/YèŠ‚"æ ¼å¼

### å®ç°ä»£ç 

**æ–‡ä»¶**ï¼š`app/Http/Controllers/Api/AttendanceController.php`  
**è¡Œå·**ï¼šç¬¬106-148è¡Œ

```php
// è®¡ç®—æ—·è¯¾æ€»èŠ‚æ¬¡æ•°ï¼ˆä»detailsä¸­è§£æï¼‰
$absentPeopleCount = $attendanceStats['absent'] ?? 0;
$absentPeriodCount = 0;

if ($absentPeopleCount > 0) {
    // è·å–æ‰€æœ‰æ—·è¯¾è®°å½•
    $absentRecords = $attendanceQuery->clone()
        ->where('status', 'absent')
        ->get(['details']);
    
    // ç»Ÿè®¡æ€»èŠ‚æ¬¡æ•°
    foreach ($absentRecords as $record) {
        $details = $record->details;
        
        // å¦‚æœdetailsæ˜¯å­—ç¬¦ä¸²ï¼Œè§£æä¸ºæ•°ç»„
        if (is_string($details)) {
            try {
                $details = json_decode($details, true);
            } catch (\Exception $e) {
                $details = null;
            }
        }
        
        // ä¼˜å…ˆä½¿ç”¨period_numbersï¼Œå¦åˆ™ä½¿ç”¨periods
        if (is_array($details)) {
            if (isset($details['period_numbers']) && is_array($details['period_numbers'])) {
                $absentPeriodCount += count($details['period_numbers']);
            } elseif (isset($details['periods']) && is_array($details['periods'])) {
                $absentPeriodCount += count($details['periods']);
            } else {
                // å¦‚æœæ²¡æœ‰periodsä¿¡æ¯ï¼ŒæŒ‰1èŠ‚è®¡ç®—
                $absentPeriodCount += 1;
            }
        } else {
            // å¦‚æœæ²¡æœ‰detailsï¼ŒæŒ‰1èŠ‚è®¡ç®—
            $absentPeriodCount += 1;
        }
    }
    
    // æ˜¾ç¤ºæ ¼å¼ï¼š2äºº/6èŠ‚
    $leaveStats['æ—·è¯¾'] = "{$absentPeopleCount}äºº/{$absentPeriodCount}èŠ‚";
}
```

---

## ğŸ“Š æ•°æ®æµ

### ç¤ºä¾‹æ•°æ®

**æ•°æ®åº“ä¸­çš„æ—·è¯¾è®°å½•**ï¼š
```json
[
  {
    "student_id": 1,
    "status": "absent",
    "details": {
      "periods": [1, 2, 12],
      "period_numbers": [1, 2, 3]
    }
  },
  {
    "student_id": 2,
    "status": "absent",
    "details": {
      "periods": [4, 6, 7],
      "period_numbers": [4, 5, 6]
    }
  }
]
```

### è®¡ç®—è¿‡ç¨‹

```
1. ç»Ÿè®¡äººæ•°ï¼š
   absentPeopleCount = 2

2. éå†è®°å½•ï¼š
   Record 1: period_numbers = [1, 2, 3] â†’ 3èŠ‚
   Record 2: period_numbers = [4, 5, 6] â†’ 3èŠ‚
   
3. ç»Ÿè®¡æ€»èŠ‚æ¬¡ï¼š
   absentPeriodCount = 3 + 3 = 6

4. ç”Ÿæˆæ˜¾ç¤ºï¼š
   "2äºº/6èŠ‚"
```

---

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### 1. å­—æ®µä¼˜å…ˆçº§

```php
if (isset($details['period_numbers'])) {
    // ä¼˜å…ˆä½¿ç”¨period_numbersï¼ˆæ–°æ ¼å¼ï¼ŒèŠ‚æ¬¡ç¼–å·ï¼‰
    $count = count($details['period_numbers']);
} elseif (isset($details['periods'])) {
    // å…¶æ¬¡ä½¿ç”¨periodsï¼ˆæ—§æ ¼å¼ï¼Œperiod IDï¼‰
    $count = count($details['periods']);
} else {
    // å¦‚æœéƒ½æ²¡æœ‰ï¼ŒæŒ‰1èŠ‚è®¡ç®—
    $count = 1;
}
```

### 2. å‘åå…¼å®¹

- **æ–°æ•°æ®**ï¼šæœ‰ `period_numbers` å­—æ®µ
- **æ—§æ•°æ®**ï¼šåªæœ‰ `periods` å­—æ®µ
- **æ— è¯¦æƒ…**ï¼šæ²¡æœ‰ `details` æˆ–æ²¡æœ‰èŠ‚æ¬¡ä¿¡æ¯

æ‰€æœ‰æƒ…å†µéƒ½èƒ½æ­£ç¡®å¤„ç†ã€‚

### 3. JSONè§£æ

```php
if (is_string($details)) {
    try {
        $details = json_decode($details, true);
    } catch (\Exception $e) {
        $details = null;
    }
}
```

Laravelçš„æ¨¡å‹å¯èƒ½è‡ªåŠ¨è§£æJSONå­—æ®µï¼Œä¹Ÿå¯èƒ½è¿”å›å­—ç¬¦ä¸²ï¼Œéœ€è¦å…¼å®¹å¤„ç†ã€‚

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼š2äººå„æ—·è¯¾3èŠ‚

**æ•°æ®**ï¼š
- Student 1: æ—·è¯¾ç¬¬1,2,3èŠ‚
- Student 2: æ—·è¯¾ç¬¬4,5,6èŠ‚

**æ˜¾ç¤º**ï¼šæ—·è¯¾ **2äºº/6èŠ‚** âœ…

### åœºæ™¯2ï¼š1äººæ—·è¯¾1èŠ‚

**æ•°æ®**ï¼š
- Student 1: æ—·è¯¾ç¬¬1èŠ‚

**æ˜¾ç¤º**ï¼šæ—·è¯¾ **1äºº/1èŠ‚** âœ…

### åœºæ™¯3ï¼š3äººæ—·è¯¾ä¸åŒèŠ‚æ¬¡

**æ•°æ®**ï¼š
- Student 1: æ—·è¯¾ç¬¬1,2èŠ‚ï¼ˆ2èŠ‚ï¼‰
- Student 2: æ—·è¯¾ç¬¬3èŠ‚ï¼ˆ1èŠ‚ï¼‰
- Student 3: æ—·è¯¾ç¬¬4,5,6,7èŠ‚ï¼ˆ4èŠ‚ï¼‰

**æ˜¾ç¤º**ï¼šæ—·è¯¾ **3äºº/7èŠ‚** âœ…

### åœºæ™¯4ï¼šæ—§æ•°æ®ï¼ˆåªæœ‰periodsï¼‰

**æ•°æ®**ï¼š
```json
{
  "details": {
    "periods": [1, 2, 3]
  }
}
```

**æ˜¾ç¤º**ï¼šæ—·è¯¾ **1äºº/3èŠ‚** âœ…ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰

### åœºæ™¯5ï¼šæ— è¯¦æƒ…æ•°æ®

**æ•°æ®**ï¼š
```json
{
  "details": null
}
```

**æ˜¾ç¤º**ï¼šæ—·è¯¾ **1äºº/1èŠ‚** âœ…ï¼ˆé»˜è®¤æŒ‰1èŠ‚è®¡ç®—ï¼‰

---

## ğŸ“ ä¿®æ”¹æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `app/Http/Controllers/Api/AttendanceController.php`ï¼ˆç¬¬106-148è¡Œï¼‰
   - æ·»åŠ æ—·è¯¾èŠ‚æ¬¡ç»Ÿè®¡é€»è¾‘
   - è§£æ `details` å­—æ®µ
   - ç”Ÿæˆ"Xäºº/YèŠ‚"æ ¼å¼

### å½±å“èŒƒå›´

- âœ… æ¦‚è§ˆé¡µé¢çš„æ—·è¯¾ç»Ÿè®¡
- âœ… æ”¯æŒæ–°æ—§æ•°æ®æ ¼å¼
- âœ… å‘åå…¼å®¹

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### æ¦‚è§ˆé¡µé¢æ˜¾ç¤º

**ä¿®æ”¹å‰**ï¼š
```
æ—·è¯¾: 2
```

**ä¿®æ”¹å**ï¼š
```
æ—·è¯¾: 2äºº/6èŠ‚
```

### å…¶ä»–ç»Ÿè®¡

å…¶ä»–ç»Ÿè®¡ï¼ˆè¿Ÿåˆ°ã€æ—©é€€ã€è¯·å‡ç­‰ï¼‰ä¿æŒä¸å˜ï¼Œä»ç„¶æ˜¾ç¤ºäººæ•°ã€‚

---

## ğŸ”„ æ‰©å±•å»ºè®®

å¦‚æœå°†æ¥éœ€è¦ä¸ºå…¶ä»–ç±»å‹ä¹Ÿæ˜¾ç¤ºèŠ‚æ¬¡ç»Ÿè®¡ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„é€»è¾‘ï¼š

```php
// è¿Ÿåˆ°èŠ‚æ¬¡ç»Ÿè®¡
if (isset($attendanceStats['late']) && $attendanceStats['late'] > 0) {
    $latePeopleCount = $attendanceStats['late'];
    $latePeriodCount = /* ç±»ä¼¼çš„è§£æé€»è¾‘ */;
    $leaveStats['è¿Ÿåˆ°'] = "{$latePeopleCount}äºº/{$latePeriodCount}èŠ‚";
}
```

---

*å®Œæˆæ—¶é—´: 2025-12-19 09:20*
*åŠŸèƒ½: æ—·è¯¾ç»Ÿè®¡æ˜¾ç¤ºäººæ•°å’ŒèŠ‚æ¬¡æ•°*
*æ ¼å¼: Xäºº/YèŠ‚*
*çŠ¶æ€: âœ… å·²å®Œæˆ*
