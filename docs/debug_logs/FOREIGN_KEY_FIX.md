# å¤–é”®çº¦æŸé”™è¯¯ä¿®å¤æŠ¥å‘Š

## ğŸ”´ é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
SQLSTATE[23000]: Integrity constraint violation: 1452 
Cannot add or update a child row: a foreign key constraint fails 
(`laravel`.`attendance_records`, 
CONSTRAINT `attendance_records_period_id_foreign` 
FOREIGN KEY (`period_id`) REFERENCES `class_periods` (`id`) 
ON DELETE SET NULL)
```

### é—®é¢˜åŸå› 
1. å‰ç«¯ä»£ç ç¡¬ç¼–ç äº†`period_id = 8`ï¼ˆæ—©æ“ï¼‰å’Œ`period_id = 9`ï¼ˆæ™šæ“ï¼‰
2. ä½†æ•°æ®åº“`class_periods`è¡¨åªæœ‰7æ¡è®°å½•ï¼ˆID 1-7ï¼‰
3. å½“å°è¯•åˆ›å»º`period_id=8`æˆ–`period_id=9`çš„è®°å½•æ—¶ï¼Œå¤–é”®çº¦æŸå¤±è´¥

### è§¦å‘åœºæ™¯
- æ ‡è®°"ç”Ÿç†å‡"å¹¶é€‰æ‹©"æ—©æ“"æˆ–"æ™šæ“"

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šåˆ›å»ºæ—©æ“å’Œæ™šæ“çš„class_periodè®°å½•

#### 1. åˆ›å»ºè¿ç§»æ–‡ä»¶

**æ–‡ä»¶**ï¼š`database/migrations/2025_12_18_002445_add_exercise_periods.php`

```php
public function up(): void
{
    $schoolId = 1;
    
    // æ—©æ“
    \App\Models\ClassPeriod::create([
        'school_id' => $schoolId,
        'name' => 'æ—©æ“',
        'start_time' => '07:00:00',
        'end_time' => '07:30:00',
        'ordinal' => 0, // åœ¨ç¬¬1èŠ‚ä¹‹å‰
    ]);
    
    // æ™šæ“
    \App\Models\ClassPeriod::create([
        'school_id' => $schoolId,
        'name' => 'æ™šæ“',
        'start_time' => '18:00:00',
        'end_time' => '18:30:00',
        'ordinal' => 99, // åœ¨æœ€å
    ]);
}
```

#### 2. è¿è¡Œè¿ç§»

```bash
php artisan migrate --path=database/migrations/2025_12_18_002445_add_exercise_periods.php
```

#### 3. éªŒè¯ç»“æœ

```json
[
    {
        "id": 8,
        "name": "æ—©æ“",
        "start_time": "07:00:00",
        "end_time": "07:30:00",
        "ordinal": 0
    },
    {
        "id": 9,
        "name": "æ™šæ“",
        "start_time": "18:00:00",
        "end_time": "18:30:00",
        "ordinal": 99
    }
]
```

#### 4. æ›´æ–°å‰ç«¯æ˜ å°„

**æ–‡ä»¶**ï¼š`resources/js/components/AttendanceUpdateModal.jsx`

```javascript
if (details.option === 'morning_exercise') {
    // æ—©æ“ - ID=8
    periodIds = [8];
} else if (details.option === 'evening_exercise') {
    // æ™šæ“ - ID=9
    periodIds = [9];
}
```

## ğŸ“Š å®Œæ•´çš„period_idæ˜ å°„

| é€‰é¡¹ | period_id | class_periodåç§° | æ—¶é—´ |
|------|-----------|-----------------|------|
| morning_exercise | 8 | æ—©æ“ | 07:00-07:30 |
| evening_exercise | 9 | æ™šæ“ | 18:00-18:30 |
| ç¬¬1èŠ‚ | 1 | Period 1 | 08:00-08:45 |
| ç¬¬2èŠ‚ | 2 | Period 2 | 08:55-09:40 |
| ç¬¬3èŠ‚ | 3 | Period 3 | 10:00-10:45 |
| ç¬¬4èŠ‚ | 4 | Period 4 | 10:55-11:40 |
| åˆä¼‘ | 5 | Lunch | 11:40-13:00 |
| ç¬¬5èŠ‚ | 6 | Period 5 | 13:00-13:45 |
| ç¬¬6èŠ‚ | 7 | Period 6 | 13:55-14:40 |

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šæ ‡è®°æ—©æ“ç”Ÿç†å‡

**æ“ä½œ**ï¼š
1. é€‰æ‹©å­¦ç”Ÿ
2. ç‚¹å‡»"ç”Ÿç†å‡"
3. é€‰æ‹©"æ—©æ“"
4. ç‚¹å‡»ç¡®è®¤

**æ•°æ®åº“**ï¼š
```
period_id | status  | leave_type | details
----------|---------|------------|-----------------------------
NULL      | present | -          | -                (è‡ªåŠ¨åˆ›å»º)
8         | excused | ç”Ÿç†å‡     | {"option":"morning_exercise"}
```

**æ˜¾ç¤º**ï¼š
```
å‡ºå‹¤ | ç”Ÿç†å‡ï¼šæ—©æ“
```

---

### åœºæ™¯2ï¼šæ ‡è®°æ™šæ“ç”Ÿç†å‡

**æ“ä½œ**ï¼š
1. é€‰æ‹©å­¦ç”Ÿ
2. ç‚¹å‡»"ç”Ÿç†å‡"
3. é€‰æ‹©"æ™šæ“"
4. ç‚¹å‡»ç¡®è®¤

**æ•°æ®åº“**ï¼š
```
period_id | status  | leave_type | details
----------|---------|------------|-----------------------------
NULL      | present | -          | -                (è‡ªåŠ¨åˆ›å»º)
9         | excused | ç”Ÿç†å‡     | {"option":"evening_exercise"}
```

**æ˜¾ç¤º**ï¼š
```
å‡ºå‹¤ | ç”Ÿç†å‡ï¼šæ™šæ“
```

---

### åœºæ™¯3ï¼šæ—©æ“ + æ™šæ“

**æ“ä½œ**ï¼š
1. æ ‡è®°"ç”Ÿç†å‡" â†’ é€‰æ‹©"æ—©æ“"
2. å†æ ‡è®°"ç”Ÿç†å‡" â†’ é€‰æ‹©"æ™šæ“"

**æ•°æ®åº“**ï¼š
```
period_id | status  | leave_type | details
----------|---------|------------|-----------------------------
NULL      | present | -          | -
8         | excused | ç”Ÿç†å‡     | {"option":"morning_exercise"}
9         | excused | ç”Ÿç†å‡     | {"option":"evening_exercise"}
```

**æ˜¾ç¤º**ï¼š
```
å‡ºå‹¤ | ç”Ÿç†å‡ï¼šæ—©æ“ | ç”Ÿç†å‡ï¼šæ™šæ“
```

## âœ… ä¼˜åŠ¿

### 1. æ•°æ®å®Œæ•´æ€§
âœ… ç¬¦åˆå¤–é”®çº¦æŸ
âœ… æ—©æ“/æ™šæ“æœ‰ç‹¬ç«‹çš„class_periodè®°å½•
âœ… å¯ä»¥ç‹¬ç«‹æ ‡è®°å’ŒæŸ¥è¯¢

### 2. çµæ´»æ€§
âœ… æ—©æ“å’Œæ™šæ“å¯ä»¥åŒæ—¶å­˜åœ¨
âœ… ä¸ä¼šç›¸äº’è¦†ç›–
âœ… æ”¯æŒå¤šç§ç»„åˆ

### 3. å¯æ‰©å±•æ€§
âœ… æœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šç‰¹æ®Šæ—¶æ®µ
âœ… å¯ä»¥ä¸ºä¸åŒå­¦æ ¡é…ç½®ä¸åŒçš„æ—¶æ®µ
âœ… ç»Ÿä¸€çš„æ•°æ®æ¨¡å‹

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1ï¼šæ—©æ“
1. åˆ·æ–°æµè§ˆå™¨
2. é€‰æ‹©å­¦ç”Ÿ
3. ç‚¹å‡»"ç”Ÿç†å‡"ï¼Œé€‰æ‹©"æ—©æ“"
4. âœ… åº”è¯¥æˆåŠŸåˆ›å»ºï¼Œæ˜¾ç¤º"å‡ºå‹¤ | ç”Ÿç†å‡ï¼šæ—©æ“"

### æµ‹è¯•2ï¼šæ™šæ“
1. ç»§ç»­é€‰æ‹©åŒä¸€å­¦ç”Ÿ
2. ç‚¹å‡»"ç”Ÿç†å‡"ï¼Œé€‰æ‹©"æ™šæ“"
3. âœ… åº”è¯¥æˆåŠŸåˆ›å»ºï¼Œæ˜¾ç¤º"å‡ºå‹¤ | ç”Ÿç†å‡ï¼šæ—©æ“ | ç”Ÿç†å‡ï¼šæ™šæ“"

### æµ‹è¯•3ï¼šå…¶ä»–æ—¶æ®µ
1. ç»§ç»­é€‰æ‹©åŒä¸€å­¦ç”Ÿ
2. ç‚¹å‡»"æ—·è¯¾"ï¼Œé€‰æ‹©"ç¬¬1èŠ‚"
3. âœ… åº”è¯¥æˆåŠŸåˆ›å»ºï¼Œæ˜¾ç¤º"å‡ºå‹¤ | æ—·è¯¾ï¼šç¬¬1èŠ‚ | ç”Ÿç†å‡ï¼šæ—©æ“ | ç”Ÿç†å‡ï¼šæ™šæ“"

## ğŸ“ å·²å®Œæˆ

1. âœ… åˆ›å»ºæ—©æ“class_periodè®°å½•ï¼ˆID=8ï¼‰
2. âœ… åˆ›å»ºæ™šæ“class_periodè®°å½•ï¼ˆID=9ï¼‰
3. âœ… æ›´æ–°å‰ç«¯æ˜ å°„é€»è¾‘
4. âœ… å‰ç«¯å·²æ„å»º
5. âœ… å¤–é”®çº¦æŸé—®é¢˜å·²è§£å†³

## ğŸ“‹ ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `database/migrations/2025_12_18_002445_add_exercise_periods.php`
   - æ–°å¢è¿ç§»æ–‡ä»¶
   - åˆ›å»ºæ—©æ“å’Œæ™šæ“è®°å½•

2. âœ… `resources/js/components/AttendanceUpdateModal.jsx`
   - æ›´æ–°period_idæ˜ å°„
   - æ—©æ“ â†’ ID=8
   - æ™šæ“ â†’ ID=9

---

*ä¿®å¤æ—¶é—´: 2025-12-18 08:24*
*é—®é¢˜: å¤–é”®çº¦æŸè¿å*
*è§£å†³æ–¹æ¡ˆ: åˆ›å»ºclass_periodè®°å½•*
*çŠ¶æ€: âœ… å®Œæˆ*
